{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Edit Profile</title>
{% endblock meta %}

{% block content %}

{% include 'delete_modal.html' %}

{% if not perms.auth.view_user %}
{% include 'navbar.html' %}
{% else %}
{% include 'navbar-admin.html' %}
{% endif %}


<style>
.input-bar {
    border-radius: 8px;
    border: 1px solid var(--Neutral-700, #666);
    background: var(--Neutral-900, #333);
    color: white;
    padding: 10px 14px;
    width: 100%;
}
.input-bar:focus {
    outline: none;
    border-color: #2CAC5C;
}
.btn-save {
    border-radius: 8px;
    border: 1px solid #6ADE7F;
    background: #2CAC5C;
    color: white;
    padding: 10px 28px;
    transition: background 0.2s ease;
    font-weight: 500;
}
.btn-save:hover {
    background: #23994E;
}
.btn-cancel {
    border-radius: 8px;
    border: 1px solid #666;
    background: #333;
    color: #ccc;
    padding: 10px 28px;
    transition: background 0.2s ease;
    font-weight: 500;
}
.btn-cancel:hover {
    background: #444;
}

.btn-danger {
    border-radius: 8px;
    border: 1px solid #e53e3e;
    background: #333;
    color: #f56565;
    padding: 10px 28px;
    transition: all 0.2s ease;
    font-weight: 500;
    width: 100%;
}
.btn-danger:hover {
    background: #4a1d1d;
    color: #fc8181;
}
.btn-secondary {
    border-radius: 8px;
    border: 1px solid #d69e2e;
    background: #333;
    color: #f6e05e;
    padding: 10px 28px;
    transition: all 0.2s ease;
    font-weight: 500;
    width: 100%;
}
.btn-secondary:hover {
    background: #4a401d;
    color: #faf089;
}
</style>

<div class="min-h-screen bg-[#1E1E1E] flex flex-col items-center justify-center pt-[100px] pb-10">
  <div class="bg-[#333] w-full max-w-[600px] rounded-[12px] px-10 py-8 shadow-sm">
      
      <div class="mb-8">
        <h1 class="text-2xl font-bold text-white mb-2">Edit Profile</h1>
      </div>

      {% if form.instance.profile.profile_picture %}
        <img src="{{ form.instance.profile.profile_picture.url }}" alt="Profile Picture"
             class="w-32 h-32 mx-auto rounded-full border-4 border-green-600 object-cover mb-4">
      {% else %}
        <img src="{% static 'image/no-profile-picture.svg' %}" alt="No Profile Picture"
             class="w-32 h-32 mx-auto rounded-full border-4 border-green-600 object-cover mb-4">
      {% endif %}

      {% if form.non_field_errors %}
        <div class="mb-6 space-y-2">
          {% for error in form.non_field_errors %}
            <div class="text-sm text-red-300">
              {{ error }}
            </div>
          {% endfor %}
        </div>
      {% endif %}

      {% if form.errors %}
        <div class="mb-6 space-y-2">
          {% for field, errors in form.errors.items %}
            {% if field != '__all__' %}
              {% for error in errors %}
                <div class="text-sm text-red-300">
                  <strong>{{ field|title }}:</strong> {{ error }}
                </div>
              {% endfor %}
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
      
      <form method="POST" enctype="multipart/form-data" class="space-y-6">
        {% csrf_token %}
          
        <div>
          <label for="username" class="block body mb-2 text-white">Username</label>
          <input 
            id="username" 
            name="username"
            value="{{ form.username.value|default:'' }}"
            type="text" 
            required 
            class="w-full input-bar" 
            placeholder="Choose a username">
        </div>

        <div>
          <label for="email" class="block body mb-2 text-white">Email</label>
          <input 
            id="email" 
            name="email" 
            type="email"
            value="{{ form.email.value|default:'' }}"
            class="w-full input-bar" 
            placeholder="Enter your Email">
        </div>

        <div>
          <label for="fullname" class="block body mb-2 text-white">Full Name</label>
          <input 
              id="fullname" 
              name="fullname" 
              type="text" 
              value="{{ form.fullname.value|default:'' }}"
              maxlength="100" 
              class="w-full input-bar" 
              placeholder="Enter your full name">
        </div>

        <div>
          <label for="bio" class="block body mb-2 text-white">Bio</label>
          <textarea 
              id="bio" 
              name="bio" 
              rows="3"
              class="w-full input-bar resize-none" 
              placeholder="Tell something about yourself">{{ form.bio.value|default:'' }}</textarea>
        </div>

        <div>
          <label for="profile_picture" class="block body mb-2 text-white">Profile Picture</label>
          {% if form.profile_picture.value %}
            <p class="text-sm text-gray-400 mb-2">Current: <a href="{{ form.profile_picture.value.url }}" class="text-green-400" target="_blank">{{ form.profile_picture.value.name }}</a></p>
          {% endif %}
          <input 
              id="profile_picture" 
              name="profile_picture" 
              type="file" 
              accept="image/*" 
              class="w-full text-white file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-green-600 file:text-white hover:file:bg-green-700">
        </div>
        
        <div class="flex flex-col sm:flex-row gap-4 pt-6 border-t border-gray-600">
          <a id="backButton" class="backButton order-2 sm:order-1 btn-cancel text-center">
            Cancel
          </a>
          <button type="submit" class="order-1 sm:order-2 flex-1 btn-save">
            Update Profile
          </button>
        </div>

        <div class="space-y-4 pt-6 border-t border-gray-600">
          <button type="button" id="changePasswordButton" class="btn-secondary">
            Change Password
          </button>
          <button type="button" id="deleteButton" class="btn-danger">
            Delete Account
          </button>
        </div>

      </form>
    </div>
</div>

<script>

const deleteButton = document.getElementById('deleteButton');
const changePasswordButton = document.getElementById('changePasswordButton');
const user_id = {{ form.instance.id }};

const backButtons = document.querySelectorAll('.backButton');
backButtons.forEach((el) => {
    setTimeout(() => {
        const back_url = "{% url 'account:view_profile' 0 %}".replace('0', user_id);
        el.href = back_url;
    }, 10);
});

deleteButton.addEventListener('click', (e) => {
  e.preventDefault(); 
  showDeleteModal({user_id: user_id });
});

changePasswordButton.addEventListener('click', (e) => {
  e.preventDefault(); 
  const url_address = "{% url 'account:change_password' 0 %}".replace('0', user_id);
  setTimeout(() => {
      window.location.href = url_address;
  }, 10);
});



</script>
{% endblock %}