{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>NobarPedia</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<!-- Hero -->
<section class="relative min-h-screen flex flex-col items-center justify-center bg-[#1E1E1E] text-white px-6 overflow-hidden">

    <!-- Rectangle blur -->
    <div class="absolute bottom-0 left-0 w-full h-[130px] bg-[#0B6044]/50 blur-2xl "></div>

  <!-- Gambar latar -->
  <div class="hidden md:flex absolute inset-0 flex items-center justify-center pointer-events-none">
    <!-- kiri atas -->
    <img src="{% static 'image/homepage1.png' %}" 
         class="absolute top-20 -left-20 w-24 md:w-96 rounded-xl object-cover" alt="">
    <!-- kanan atas -->
    <img src="{% static 'image/homepage2.png' %}" 
         class="absolute top-20 -right-20 w-24 md:w-96 rounded-xl object-cover" alt="">
    <!-- kiri bawah -->
    <img src="{% static 'image/homepage2.png' %}" 
         class="absolute bottom-4 -left-40 w-24 md:w-96 rounded-xl object-cover" alt="">
    <!-- kanan bawah -->
    <img src="{% static 'image/homepage1.png' %}" 
         class="absolute bottom-4 -right-40 w-24 md:w-96 rounded-xl object-cover" alt="">
  </div>

    <!-- Desktop teks -->
  <div class="hidden md:block relative text-center max-w-xl z-10">
    <h1 class="text-5xl mb-4 tracking-wide">LOREM IPSUM DOLORES</h1>
    <p class="text-gray-300 mb-6 text-base">
      Temukan tempat nobar terbaik di sekitarmu. Gabung komunitas sesama pecinta bola dan rasakan atmosfer pertandingan bersama!
    </p>
    <a href="#list-spots"
      class="bg-green-600 hover:bg-green-700 text-white font-medium px-6 py-3 rounded-md transition">
      Cari tempat nobar
    </a>
  </div>

   <!-- Mobile teks -->
  <div class="flex flex-col items-center justify-center md:hidden z-10">
    <!-- Teks -->
    <h1 class="text-2xl mb-3 text-center tracking-wide">LOREM IPSUM DOLORES</h1>
    <p class="text-gray-300 text-center mb-4 text-sm">
      Temukan tempat nobar terbaik di sekitarmu. Gabung komunitas sesama pecinta bola dan rasakan atmosfer pertandingan bersama!
    </p>
    <a href="#list-spots"
      class="bg-green-600 hover:bg-green-700 text-white font-medium px-6 py-3 rounded-md transition">
      Cari tempat nobar
    </a>


    <!-- Gambar Mobile -->
    <div class="relative w-full max-w-xl grid grid-cols-2 gap-0 mt-4">
    <!-- kiri -->
    <img 
        src="{% static 'image/homepage1.png' %}" 
        class="w-full h-32 object-cover rounded-xl -translate-x-8 md:-translate-x-20" 
        alt="">
    <!-- kanan -->
    <img 
        src="{% static 'image/homepage2.png' %}" 
        class="w-full h-32 object-cover rounded-xl translate-x-8 md:translate-x-20" 
        alt="">
    </div>

  </div>
</section>

<!-- List of spots -->
<section id="list-spots" class="relative flex flex-col items-center text-white bg-[#1E1E1E] py-20 w-full">
  <!-- Judul -->
  <h2 class="text-2xl md:text-3xl mb-8 tracking-wide text-center">
    Pick your spot!
  </h2>


{% if user.is_authenticated %}
  <!-- Tombol Desktop -->
  <div class="relative w-full max-w-3xl hidden md:flex justify-center mt-8 items-center">

    <a href="{% url 'homepage:create_spot' %}"
      class="absolute -left-48 bg-green-600 hover:bg-green-700 text-white font-medium px-5 py-2 rounded-md transition">
      + Add New Spot
    </a>

    <!-- Tombol tengah -->
    <div class="flex gap-4">
      <button class="bg-green-600 hover:bg-green-700 text-white font-medium px-5 py-2 rounded-md transition">
        All Spot
      </button>
      <button class="border border-green-600 text-white font-medium px-5 py-2 rounded-md hover:bg-green-600 transition">
        Your Spot
      </button>
    </div>
  </div>
  {% endif %}

  {% if user.is_authenticated %}
  <!-- Tombol Mobile -->
  <div class="w-full flex flex-col items-center gap-4 mt-8 md:hidden">
    
    <a href="{% url 'homepage:create_spot' %}"
      class="bg-green-600 hover:bg-green-700 text-white font-medium px-5 py-2 rounded-md transition w-[70%] text-center">
      + Add New Spot
    </a>

    <!-- Tombol tengah -->
    <div class="flex justify-center gap-4 w-[70%]">
      <a id="filter-all" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium px-5 py-2 rounded-md transition">
        All Spot
      </a>
      <a id="filter-my" class="flex-1 border border-green-600 text-white font-medium px-5 py-2 rounded-md hover:bg-green-600 transition">
        Your Spot
      </a>
    </div>

   </div>
  {% endif %}

    <!-- Loading Spinner -->
  <div id="loading" class="bg-[#1E1E1E] text-center py-12 hidden">
    <svg class="animate-spin h-8 w-8 text-green-600 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
    </svg>
    <p class="text-gray-400 mt-3">Loading spots...</p>
  </div>

  <!-- Error State -->
  <div id="error" class="hidden text-red-500 text-center py-12">Failed to load spots. Please try again later.</div>

  <!-- Empty State -->
  <div id="empty" class="hidden text-center py-16">
    <h3 class="text-xl mb-2">No spots found</h3>
    <p class="text-gray-400 mb-6">Be the first to create a new spot!</p>
    <a href="{% url 'homepage:create_spot' %}" class="bg-green-600 hover:bg-green-700 text-white font-medium px-5 py-2 rounded-md transition">
      + Add New Spot
    </a>
  </div>

  <!-- Grid Container -->
  <div id="spot-grid" class="hidden grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6 mt-12 w-[90%] md:w-[80%]"></div>


</section>

<script>
const SPOT_API = "{% url 'homepage:show_json' %}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

const loading = document.getElementById('loading');
const error = document.getElementById('error');
const empty = document.getElementById('empty');
const grid = document.getElementById('spot-grid');

const allBtn = document.getElementById('filter-all');
const yourBtn = document.getElementById('filter-my');

let allSpots = [];
let activeFilter = 'all';

// Update filter button appearance
function updateFilterButtonsAppearance() {
  if (!allBtn || !yourBtn) return;
  
  if (activeFilter === 'all') {
    allBtn.className = 'flex-1 bg-green-600 hover:bg-green-700 text-white font-medium px-5 py-2 rounded-md transition';
    yourBtn.className = 'flex-1 border border-green-600 text-white font-medium px-5 py-2 rounded-md hover:bg-green-600 transition';
  } else {
    yourBtn.className = 'flex-1 bg-green-600 hover:bg-green-700 text-white font-medium px-5 py-2 rounded-md transition';
    allBtn.className = 'flex-1 border border-green-600 text-white font-medium px-5 py-2 rounded-md hover:bg-green-600 transition';
  }
}

// Toggle visibility
function showSection({ loading: showLoading=false, error: showError=false, empty: showEmpty=false, grid: showGrid=false }) {
  loading.classList.toggle('hidden', !showLoading);
  error.classList.toggle('hidden', !showError);
  empty.classList.toggle('hidden', !showEmpty);
  grid.classList.toggle('hidden', !showGrid);
}

// Build one card
function buildSpotCard(spot) {
    const div = document.createElement('div');
    div.className = "bg-white rounded-xl shadow hover:shadow-lg transition overflow-hidden text-gray-900 flex flex-col";

    const linkDetail = `{% url 'homepage:show_homepage'%}`;
    const linkEdit = `{% url 'homepage:edit_spot' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', spot.id);
    const linkDelete = `{% url 'homepage:delete_spot' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', spot.id);

    const formattedTime = spot.time ? spot.time.split(':').slice(0, 2).join(':') : '';

    let editdeleteButtons = '';
    if (CURRENT_USER_ID && Number(CURRENT_USER_ID) === Number(spot.host_id)){
      editdeleteButtons =  `
      <div class="flex gap-2 ml-3">
        <a href="${linkEdit}" class="text-green-600 hover:text-green-700 text-sm font-medium py-2 px-1">Edit</a>
        <a href="${linkDelete}" 
            onclick="return confirm('Apakah Anda yakin ingin menghapus Spot ini?')"
            class="text-red-600 hover:text-red-700 text-sm font-medium py-2 px-1">Hapus</a>
      </div>
    `;
    }

    div.innerHTML = `
        <div class="p-2"> 
            <div class="aspect-[16/9] overflow-hidden rounded-lg">
                <img src="${spot.thumbnail || 'https://placehold.co/600x400'}" class="w-full h-full object-cover" alt="thumbnail">
            </div>
        </div>

        <div class="p-4 flex flex-col flex-1">
            <div class="mb-3">
                <span class="bg-white text-[#2CAC5C] text-sm font-medium me-2 px-2.5 py-0.5 rounded-full border border-[#2CAC5C]">${spot.home_team} vs ${spot.away_team}</span>
            </div>

            <div class="flex justify-between items-start mb-2">
                <h3 class=" headline text-lg leading-tight flex-1 text-black truncate">${spot.name}</h3>
                <p class="footnote text-xs text-gray-500 whitespace-nowrap ml-4">${new Date(spot.date).toLocaleDateString('en-US', { month:'short',day:'2-digit' })} | ${formattedTime}</p>
            </div>
            <p class="footnote text-sm text-gray-500 mb-4">${spot.city}</p>
            
            <div class="mt-auto flex items-center pt-2">
               <a href="${linkDetail}" class="flex-1 bg-green-600 hover:bg-green-700 text-white text-base font-medium px-4 py-2 rounded-md text-center">Detail</a>
                    ${editdeleteButtons}
            </div>

        </div>
    `;
    return div;
}

// Render grid
function renderSpots(spots) {
  grid.innerHTML = '';
  spots.forEach(s => grid.appendChild(buildSpotCard(s)));
}

// Filter
function filterSpots() {
  updateFilterButtonsAppearance();

  const filtered = activeFilter === 'all'
    ? allSpots
    : allSpots.filter(s => Number(s.host_id) === Number(CURRENT_USER_ID));

  if (filtered.length === 0) {
    showSection({ empty: true });
  } else {
    renderSpots(filtered);
    showSection({ grid: true });
  }
}

// Fetch
async function fetchSpots() {
  try {
    showSection({ loading: true });
    const res = await fetch(SPOT_API);
    if (!res.ok) throw new Error("Failed to fetch");
    const data = await res.json();
    allSpots = data;
    filterSpots();
  } catch (e) {
    showSection({ error: true });
  }
}

// Buttons
if (allBtn) {
  allBtn.addEventListener('click', (e) => {
    e.preventDefault();
    activeFilter = 'all';
    fetchSpots();
  });
}

if (yourBtn) {
  yourBtn.addEventListener('click', (e) => {
    e.preventDefault();
    activeFilter = 'your';
    fetchSpots();
  });
}

// Start
document.addEventListener('DOMContentLoaded', fetchSpots);
</script>


{% endblock content %}