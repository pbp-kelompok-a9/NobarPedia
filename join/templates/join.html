{% extends 'base.html' %}
{% block content %}
{% include 'navbar.html' %}
<div class=" text-white w-screen h-full pt-16 flex flex-col  items-center">
  
  <div class="w-[85vw] aspect-[5/1] my-6 overflow-clip relative rounded flex">
      <img src="https://image.idntimes.com/post/20250609/1000437318.jpg" class="absolute object-cover w-full h-full -z-10 opacity-50" alt="banner">
      <div class="w-1/2 p-4 self-end">
        <h1 class="text-2xl mb-2 text-4xl">Bring the <span class="text-green-500">Stadium</span> Closer to You</h1>
        <h2 class="font_poppins text-[0.7rem]">Experience the thrill of football, together</h2>
      </div>
    </div>
  </div>

  <div class="w-[85vw] flex text-center mx-auto bg-neutral-700 rounded text-sm mb-8">
    <a id="filter_joined_spots" class="w-1/2 p-1">Joined Spot</a>
    <a id="filter_my_spots" class="w-1/2 p-1">My Nobar Spot</a>
  </div>

  <div id="join_grid" class="w-[75vw] grid grid-cols-2 gap-8 mx-auto">
     
  </div>   
</div>
<script>
// Configuration
const JOIN_API_ENDPOINT = "{% url 'join:get_join' %}";
const MY_NOBAR_SPOTS_API_ENDPOINT = "{% url 'homepage:get_user_nobar_spots' %}";
const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";

// DOM Elements
const join_grid = document.getElementById('join_grid');
const filter_joined_spots = document.getElementById('filter_joined_spots')
const filter_my_spots = document.getElementById('filter_my_spots')

// State Variables
let activeFilter = 'joined';
let allJoinData = [];
let allMyNobarSpotsData = [];

// Update filter button appearance
function updateFilterButtonsAppearance() {
  if (!filter_joined_spots || !filter_my_spots) return;
  
  if (activeFilter === 'joined') {
    filter_joined_spots.className = 'w-1/2 p-1 bg-gradient-to-l from-green-600/30 to-transparent';
    filter_my_spots.className = 'w-1/2 p-1';
  } else {
    filter_my_spots.className = 'w-1/2 p-1 bg-gradient-to-r from-green-600/30 to-transparent';
    filter_joined_spots.className = 'w-1/2 p-1';
  }
}

// Get readable category name
function getReadableCategoryName(categoryCode) {
  const categoryMapping = {
    pasti: 'Pasti',
    mungkin: 'Mungkin',
  };
  return categoryMapping[categoryCode] || categoryCode;
}

// Create join card element
function buildCardElement(item, type) {
    const article = document.createElement('article');

    let title, time, content, category, id, user_id, linkEdit, linkDelete, editDeleteHtml;
    let statusPrefix = '';

    if (type === 'join') {
        id = item.id;
        title = item.nobar_place_name;
        time = item.nobar_place_time;
        content = item.nobar_place_city;
        category = item.status;
        user_id = item.user_id;
        statusPrefix = 'Status: ';

        linkEdit = `{% url 'join:update_join' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id);
        linkDelete = `{% url 'join:delete_join' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id);

        editDeleteHtml = CURRENT_USER_ID && CURRENT_USER_ID === user_id
            ? `<div class='flex gap-4 justify-end self-end pt-4'>
                <a href='${linkEdit}' class='text-green-500 hover:text-gray-700 transition-colors'>Edit</a>
                <a href='${linkDelete}' class='text-red-600 hover:text-red-800 transition-colors' onclick='return confirm("Are you sure you want to delete this entry?")'>Delete</a>
              </div>`
            : '';

    } else if (type === 'nobar_spot') {
        id = item.id;
        title = item.name;
        time = item.time;
        content = item.city;
        category = `Joined: ${item.joined_count}`; 
        user_id = item.host_id; 
        statusPrefix = ''; 

        linkEdit = `{% url 'homepage:edit_spot' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id);
        linkDelete = `{% url 'homepage:delete_spot' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', id);

        editDeleteHtml = CURRENT_USER_ID && CURRENT_USER_ID === user_id
            ? `<div class='flex gap-4 justify-end self-end pt-4'>
                <a href='${linkEdit}' class='text-green-500 hover:text-gray-700 transition-colors'>Edit</a>
                <a href='${linkDelete}' class='text-red-600 hover:text-red-800 transition-colors' onclick='return confirm("Are you sure you want to delete this spot?")'>Delete</a>
              </div>`
            : '';
    }

    const categoryLabel = getReadableCategoryName(category);

    const cardHtml = `
        <div class="bg-neutral-700 w-full rounded p-2 text-sm">
          <div class="w-full flex justify-between items-center">
            <div>${title}</div>
            <div class="text-xs">üïê ${time}</div>
          </div>
          <div class="text-neutral-400 text-xs">${content}</div>
          <div class="text-center pt-4">${statusPrefix}${categoryLabel}</div>
          ${editDeleteHtml}
        </div>
    `;
    
    article.innerHTML = cardHtml;
    return article;
}

// Render all cards
function renderAllCards(items, type) {
  join_grid.innerHTML = '';
  items.forEach(item => {
    const cardElement = buildCardElement(item, type);
    join_grid.appendChild(cardElement);
  });
}

// Filter and display join
async function filterAndDisplayJoin() {
  updateFilterButtonsAppearance();
  
  if (activeFilter === 'joined') {
    renderAllCards(allJoinData, 'join');
  }
  else if (activeFilter === 'my') {
    renderAllCards(allMyNobarSpotsData, 'nobar_spot');
  }
}


// Fetch all data from server
async function fetchAllData() {
  try {
    // Fetch Joined Spots
    const joinResponse = await fetch(JOIN_API_ENDPOINT, {
      headers: { 'Accept': 'application/json' },
    });
    if (!joinResponse.ok) {
      throw new Error('Failed to fetch join data from server');
    }
    allJoinData = await joinResponse.json() || [];

    // Fetch My Nobar Spots
    const myNobarSpotsResponse = await fetch(MY_NOBAR_SPOTS_API_ENDPOINT, {
        headers: { 'Accept': 'application/json' },
    });
    if (!myNobarSpotsResponse.ok) {
        throw new Error('Failed to fetch my nobar spots data from server');
    }
    allMyNobarSpotsData = await myNobarSpotsResponse.json() || [];
    
    filterAndDisplayJoin();
  } catch (error) {
    console.error('Error loading data:', error);
  }
}

// Event handlers
function handleShowJoinedClick() {
  activeFilter = 'joined';
  filterAndDisplayJoin();
}

function handleShowMyJoinClick() {
  activeFilter = 'my';
  filterAndDisplayJoin();
}

// Initialize page
function initializeJoinPage() {
  filter_joined_spots.addEventListener('click', handleShowJoinedClick);
  filter_my_spots.addEventListener('click', handleShowMyJoinClick);
  
  fetchAllData();
}


// Start application
initializeJoinPage();
</script>
{% endblock content%}